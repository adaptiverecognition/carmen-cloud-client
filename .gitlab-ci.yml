image: maven:3.6.3-jdk-11

variables:
  MAVEN_CLI_OPTS: "--batch-mode --update-snapshots"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  MAVEN_REPO_URL: "http://192.168.254.97:8081/artifactory"
  MAVEN_CENTRAL_REPO: "http://192.168.254.97:8081/artifactory/libs-release"
  MAVEN_SNAPSHOTS_REPO: "http://192.168.254.97:8081/artifactory/libs-snapshot"

cache:
  paths:
#  - target/

build:
  stage: build
  script:
  - mvn $MAVEN_CLI_OPTS --activate-profiles default compile
  only:
  - develop

test:
  stage: test
  script:
  - mvn $MAVEN_CLI_OPTS --activate-profiles default test
  only:
  - develop

deploy:
  stage: deploy
  script:
  - mvn $MAVEN_CLI_OPTS --activate-profiles default -DaltDeploymentRepository=snapshots::default::$MAVEN_SNAPSHOTS_REPO deploy
  only:
  - develop

release:
  stage: deploy
  script:
  - mvn versions:set -DgenerateBackupPoms=false -DnewVersion=$CI_COMMIT_TAG
  - mvn $MAVEN_CLI_OPTS --activate-profiles production -DaltDeploymentRepository=central::default::$MAVEN_CENTRAL_REPO deploy
  rules:
    - if: '$CI_COMMIT_TAG != null'
