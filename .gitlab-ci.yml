image: maven:3.6.3-jdk-11

variables:
  MAVEN_CLI_OPTS: "--batch-mode --update-snapshots"
  MAVEN_REPO_URL: "${env.CI_SERVER_URL}/api/v4/projects/${env.CI_PROJECT_ID}/packages/maven"

cache:
  paths:
#  - target/

build:
  stage: build
  script:
  - mvn $MAVEN_CLI_OPTS --activate-profiles default compile
  only:
  - develop

test:
  stage: test
  script:
  - mvn $MAVEN_CLI_OPTS --activate-profiles default test
  only:
  - develop

deploy:
  stage: deploy
  script:
  - mvn $MAVEN_CLI_OPTS --activate-profiles default -DaltDeploymentRepository=snapshots::default::$MAVEN_REPO_URL deploy
  before_script:
  - update-ca-certificates
  only:
  - develop

release:
  stage: deploy
  script:
  - mvn versions:set -DgenerateBackupPoms=false -DnewVersion=$CI_COMMIT_TAG
  - mvn $MAVEN_CLI_OPTS --activate-profiles production -DaltDeploymentRepository=central::default::$MAVEN_REPO_URL deploy
  before_script:
  - update-ca-certificates
  rules:
    - if: '$CI_COMMIT_TAG != null'
